<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAX Multi-Client Upgrade Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary: #2ea44f; --dark: #24292e; --bg: #f6f8fa; --border: #d1d5da; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #24292e; }
        
        /* Header & Controls */
        .header { background: var(--dark); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .controls { display: flex; gap: 12px; flex-wrap: wrap; background: #fff; padding: 15px 2rem; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; align-items: center; }
        
        /* Layout */
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 16px; position: relative; }
        .step-done { background: #f0fff4; border-left: 6px solid var(--primary); }
        
        /* Elements */
        pre { background: #1b1f23; color: #e1e4e8; padding: 16px; border-radius: 6px; overflow-x: auto; font-family: ui-monospace, monospace; font-size: 13px; position: relative; }
        .copy-btn { position: absolute; top: 8px; right: 8px; background: #0366d6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        textarea { width: 100%; margin-top: 10px; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: inherit; box-sizing: border-box; }
        input, select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
        
        /* Status Indicators */
        .status-area { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; background: #d1d5da; }
        .online { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
        .error-msg { background: #ffeef0; color: #d73a49; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none; border: 1px solid #f97583; }
        
        /* Stage Navigation */
        .stage-tabs { display: flex; gap: 8px; background: white; padding: 15px 2rem; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .stage-tab { padding: 10px 20px; border-radius: 6px 6px 0 0; cursor: pointer; background: var(--bg); border: 1px solid var(--border); border-bottom: none; transition: all 0.2s; white-space: nowrap; }
        .stage-tab:hover { background: #e1e4e8; }
        .stage-tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -1px; font-weight: 600; color: var(--primary); }
        
        /* Progress Indicator */
        .progress-bar { height: 8px; background: var(--bg); border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #34d058); transition: width 0.3s ease; }
        
        /* Stage Navigation Buttons */
        .stage-nav { display: flex; justify-content: space-between; margin: 20px 0; }
        .stage-nav button { padding: 10px 20px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: white; font-weight: 500; }
        .stage-nav button:hover { background: var(--bg); }
        .stage-nav button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Markdown Notes */
        .note-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .note-header h5 { margin: 0; color: #586069; font-size: 14px; }
        .note-toggle { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 12px; text-decoration: underline; }
        .note-editor { display: none; }
        .note-editor.active { display: block; }
        .note-preview { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 12px; min-height: 40px; color: #24292e; }
        .note-preview h1, .note-preview h2, .note-preview h3 { margin-top: 0; }
        .note-preview code { background: #1b1f23; color: #e1e4e8; padding: 2px 6px; border-radius: 3px; font-family: ui-monospace, monospace; }
        .note-preview pre { background: #1b1f23; color: #e1e4e8; padding: 12px; border-radius: 6px; overflow-x: auto; }
        .note-preview pre code { background: none; padding: 0; }
        .note-preview ul, .note-preview ol { padding-left: 25px; }
        .note-preview blockquote { border-left: 4px solid var(--border); padding-left: 15px; color: #586069; margin: 10px 0; }
        
        /* Reset Button */
        .reset-btn { background: #d73a49; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .reset-btn:hover { background: #cb2431; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border: 1px solid var(--border); border-radius: 6px; width: 400px; max-width: 90%; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    </style>
</head>
<body>

<div class="header">
    <strong>SMAX Multi-Tenant Operations</strong>
    <div class="status-area">
        <div id="syncInd" class="indicator"></div>
        <span id="syncStat">Offline</span>
    </div>
</div>

<div class="controls">
    <input type="password" id="ghToken" placeholder="Paste GitHub Token" onchange="connect()">
    
    <select id="selVer" onchange="loadData()">
        <option value="24.1">Version 24.1</option>
        <option value="24.2">Version 24.2</option>
    </select>

    <select id="selClient" onchange="loadData()">
        <option value="">Loading clients...</option>
    </select>

    <button onclick="saveData()" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
        üíæ Save Progress
    </button>
    
    <button onclick="showResetModal()" class="reset-btn">
        üîÑ Reset All Done Steps
    </button>
</div>

<div id="stage-tabs-container" class="stage-tabs" style="display: none;"></div>

<div class="container">
    <div id="errorBox" class="error-msg"></div>
    
    <div id="progress-container" style="display: none;">
        <h4>Stage Progress</h4>
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        <div style="font-size: 12px; color: #586069; margin-top: 5px;">
            <span id="progress-text">0 of 0 steps completed</span>
        </div>
    </div>

    <div class="card" id="env-vars-card">
        <h4 style="margin-top:0">Environment Variables</h4>
        <div id="var-inputs" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;"></div>
    </div>
    
    <div class="stage-nav" id="stage-nav" style="display: none;">
        <button id="prev-stage-btn" onclick="prevStage()">‚Üê Previous Stage</button>
        <button id="next-stage-btn" onclick="nextStage()">Next Stage ‚Üí</button>
    </div>

    <div id="steps-list"></div>
    
    <div class="stage-nav" id="stage-nav-bottom" style="display: none;">
        <button id="prev-stage-btn-bottom" onclick="prevStage()">‚Üê Previous Stage</button>
        <button id="next-stage-btn-bottom" onclick="nextStage()">Next Stage ‚Üí</button>
    </div>
</div>

<!-- Reset Confirmation Modal -->
<div id="resetModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top: 0;">Reset Completed Steps</h3>
        <p>Are you sure you want to reset all completed steps? This will mark all steps as incomplete.</p>
        <div class="modal-buttons">
            <button onclick="closeResetModal()" style="padding: 8px 16px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; background: white;">
                Cancel
            </button>
            <button onclick="confirmReset()" class="reset-btn">
                Reset All
            </button>
        </div>
    </div>
</div>

<script>
let GITHUB_TOKEN = "";
    let FILE_SHA = "";
    let CURRENT_YAML_PATH = "";
    let config = { config: {}, stages: [] };
    let currentStageIndex = 0;

    // Hardcoded repository information for personal use
    const OWNER = "gianandr4";
    const REPO = "SMAX-Upgrade-Tool"; 

    async function connect() {
        GITHUB_TOKEN = document.getElementById('ghToken').value;
        if (!GITHUB_TOKEN) {
            showError('Please enter a GitHub token');
            return;
        }
        console.log('[SMAX Tool] Connecting with GitHub token...');
        // Step 1: Dynamically find folders
        await fetchFolders();
        // Step 2: Load data for the first folder found
        loadData();
    }

    // NEW: Automatically find version folders (e.g., 24.4, 25.1)
    async function fetchFolders() {
        if (!GITHUB_TOKEN) return;
        try {
            console.log(`[SMAX Tool] Fetching folders from ${OWNER}/${REPO}...`);
            const resp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            
            if (!resp.ok) {
                const errorData = await resp.json();
                throw new Error(`GitHub API: ${errorData.message || resp.statusText}`);
            }
            
            const items = await resp.json();
            const folderSelect = document.getElementById('selVer');
            
            // Clear existing options
            folderSelect.innerHTML = "";

            // Filter for directories that look like versions (numbers/dots)
            const folders = items.filter(item => item.type === 'dir' && !item.name.startsWith('.'));
            
            if (folders.length === 0) {
                showError('No version folders found in repository');
                return;
            }
            
            folders.forEach(folder => {
                const opt = document.createElement('option');
                opt.value = folder.name;
                opt.innerText = `Version ${folder.name}`;
                folderSelect.appendChild(opt);
            });
            
            console.log(`[SMAX Tool] Found ${folders.length} version folder(s)`);
            
            // Load clients for the first version
            if (folders.length > 0) {
                await fetchClients(folders[0].name);
            }
        } catch (e) {
            console.error('[SMAX Tool] fetchFolders error:', e);
            showError(`Failed to load folders: ${e.message}`);
        }
    }
    
    // NEW: Fetch clients from version folder
    async function fetchClients(version) {
        if (!GITHUB_TOKEN) return;
        try {
            console.log(`[SMAX Tool] Fetching clients from ${version}/...`);
            const resp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${version}`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            
            if (!resp.ok) {
                const errorData = await resp.json();
                throw new Error(`GitHub API: ${errorData.message || resp.statusText}`);
            }
            
            const items = await resp.json();
            const clientSelect = document.getElementById('selClient');
            
            // Clear existing options
            clientSelect.innerHTML = "";
            
            // Find all client YAML files (excluding state- and template files)
            const clientFiles = items.filter(item => 
                item.type === 'file' && 
                item.name.endsWith('.yaml') && 
                !item.name.startsWith('state-') &&
                !item.name.startsWith('managed-') &&
                !item.name.startsWith('embedded-')
            );
            
            if (clientFiles.length === 0) {
                clientSelect.innerHTML = '<option value="">No clients found</option>';
                return;
            }
            
            // Extract client names
            const clients = new Set();
            clientFiles.forEach(file => {
                // Extract client name from filename (e.g., "client-A-managed-steps.yaml" -> "client-A")
                const match = file.name.match(/^(.+?)-(?:managed|embedded)-steps\.yaml$/);
                if (match) {
                    clients.add(match[1]);
                } else {
                    // New format: just client name (e.g., "client-A.yaml")
                    const clientName = file.name.replace('.yaml', '');
                    clients.add(clientName);
                }
            });
            
            clients.forEach(client => {
                const opt = document.createElement('option');
                opt.value = client;
                opt.innerText = client.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                clientSelect.appendChild(opt);
            });
            
            console.log(`[SMAX Tool] Found ${clients.size} client(s)`);
        } catch (e) {
            console.error('[SMAX Tool] fetchClients error:', e);
            showError(`Failed to load clients: ${e.message}`);
        }
    }

    async function loadData() {
        showError(""); 
        const ver = document.getElementById('selVer').value;
        const client = document.getElementById('selClient').value;
        
        if (!ver || !client) {
            console.log('[SMAX Tool] Waiting for version and client to be selected...');
            return;
        }

        // Try new unified format first: {version}/{client}.yaml
        CURRENT_YAML_PATH = `${ver}/${client}.yaml`;

        try {
            console.log(`[SMAX Tool] Loading unified YAML from ${CURRENT_YAML_PATH}...`);
            
            let yamlContent;
            
            if (GITHUB_TOKEN) {
                // Load from GitHub
                const resp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${CURRENT_YAML_PATH}`, {
                    headers: { Authorization: `token ${GITHUB_TOKEN}` }
                });
                
                if (resp.status === 404) {
                    // Try to migrate from old format
                    console.log('[SMAX Tool] New format not found, attempting migration from old format...');
                    await migrateFromOldFormat(ver, client);
                    return; // migrateFromOldFormat will call loadData again
                }
                
                if (!resp.ok) {
                    const errorData = await resp.json();
                    throw new Error(`GitHub API: ${errorData.message || resp.statusText}`);
                }
                
                const data = await resp.json();
                FILE_SHA = data.sha;
                yamlContent = atob(data.content);
            } else {
                // Load from local file (development mode)
                const resp = await fetch(CURRENT_YAML_PATH);
                if (!resp.ok) throw new Error(`YAML file not found: ${CURRENT_YAML_PATH}`);
                yamlContent = await resp.text();
            }
            
            config = jsyaml.load(yamlContent);
            
            if (!config) {
                throw new Error('Invalid YAML structure');
            }
            
            // Backward compatibility: Convert old 'steps' to 'stages'
            if (config.steps && !config.stages) {
                console.log('[SMAX Tool] Converting old steps format to stages...');
                config.stages = [{
                    name: 'Upgrade',
                    steps: config.steps
                }];
                delete config.steps;
            }
            
            if (!config.stages || config.stages.length === 0) {
                throw new Error('Invalid YAML structure: missing stages');
            }
            
            // Ensure each step has required fields
            config.stages.forEach(stage => {
                stage.steps = stage.steps || [];
                stage.steps.forEach(step => {
                    step.done = step.done || false;
                    step.notes = step.notes || '';
                });
            });
            
            console.log(`[SMAX Tool] Loaded ${config.stages.length} stage(s)`);
            
            if (GITHUB_TOKEN) {
                document.getElementById('syncInd').classList.add('online');
                document.getElementById('syncStat').innerText = `Synced: ${ver}/${client}`;
                console.log('[SMAX Tool] Data synced from GitHub');
            }
            
            currentStageIndex = 0;
            renderVars();
            renderStageTabs();
            renderCurrentStage();
            updateProgress();
            
        } catch (e) {
            console.error('[SMAX Tool] loadData error:', e);
            showError(e.message);
        }
    }
    
    // NEW: Migrate from old format to new unified format
    async function migrateFromOldFormat(ver, client) {
        try {
            console.log('[SMAX Tool] Migrating from old format...');
            
            // Try to load old managed or embedded steps file
            let oldStepsPath = `${ver}/${client}-managed-steps.yaml`;
            let oldStatePath = `${ver}/state-${client}.yaml`;
            
            let stepsResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${oldStepsPath}`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            
            if (stepsResp.status === 404) {
                // Try embedded format
                oldStepsPath = `${ver}/${client}-embedded-steps.yaml`;
                stepsResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${oldStepsPath}`, {
                    headers: { Authorization: `token ${GITHUB_TOKEN}` }
                });
            }
            
            if (!stepsResp.ok) {
                throw new Error(`No client configuration found for ${client}`);
            }
            
            const stepsData = await stepsResp.json();
            const oldConfig = jsyaml.load(atob(stepsData.content));
            
            // Load old state file if exists
            let state = {};
            const stateResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${oldStatePath}`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            
            if (stateResp.ok) {
                const stateData = await stateResp.json();
                state = jsyaml.load(atob(stateData.content)) || {};
            }
            
            // Create new unified config
            const newConfig = {
                config: oldConfig.config || {},
                stages: [{
                    name: 'Upgrade',
                    steps: (oldConfig.steps || []).map(step => {
                        return {
                            ...step,
                            done: state[`s_done_${step.id}`] === 'true',
                            notes: ''
                        };
                    })
                }]
            };
            
            // Apply variable state
            Object.keys(newConfig.config).forEach(key => {
                if (state[`v_${key}`]) {
                    newConfig.config[key] = state[`v_${key}`];
                }
            });
            
            // Save new format
            config = newConfig;
            FILE_SHA = ""; // Will create new file
            await saveData();
            
            console.log('[SMAX Tool] Migration complete, reloading...');
            
        } catch (e) {
            console.error('[SMAX Tool] Migration error:', e);
            showError(`Migration failed: ${e.message}`);
        }
    }

    // Error handling with better logging
    function showError(msg) {
        const box = document.getElementById('errorBox');
        if (msg) {
            console.error('[SMAX Tool Error]:', msg);
            box.innerText = `‚ö†Ô∏è Error: ${msg}`;
            box.style.display = 'block';
        } else {
            box.style.display = 'none';
        }
    }

    // Render environment variables
    function renderVars() {
        const varInputs = document.getElementById('var-inputs');
        varInputs.innerHTML = '';
        
        if (!config.config) return;
        
        Object.entries(config.config).forEach(([key, defaultVal]) => {
            const wrapper = document.createElement('div');
            
            // Create label
            const label = document.createElement('label');
            label.style.fontSize = '12px';
            label.style.color = '#586069';
            label.style.display = 'block';
            label.style.marginBottom = '4px';
            label.textContent = key;
            
            // Create input
            const input = document.createElement('input');
            input.type = 'text';
            input.id = `var_${key}`;
            input.value = defaultVal;
            input.style.width = '100%';
            input.style.boxSizing = 'border-box';
            input.onchange = function() {
                config.config[key] = this.value;
            };
            
            wrapper.appendChild(label);
            wrapper.appendChild(input);
            varInputs.appendChild(wrapper);
        });
    }
    
    // NEW: Render stage tabs
    function renderStageTabs() {
        const container = document.getElementById('stage-tabs-container');
        container.innerHTML = '';
        container.style.display = 'flex';
        
        if (!config.stages || config.stages.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        config.stages.forEach((stage, index) => {
            const tab = document.createElement('div');
            tab.className = 'stage-tab';
            if (index === currentStageIndex) {
                tab.className += ' active';
            }
            
            // Calculate completion for this stage
            const totalSteps = stage.steps.length;
            const completedSteps = stage.steps.filter(s => s.done).length;
            
            tab.innerHTML = `
                <div>${stage.name}</div>
                <div style="font-size: 11px; color: #586069; margin-top: 3px;">
                    ${completedSteps}/${totalSteps} steps
                </div>
            `;
            
            tab.onclick = () => {
                currentStageIndex = index;
                renderStageTabs();
                renderCurrentStage();
                updateProgress();
            };
            
            container.appendChild(tab);
        });
    }
    
    // NEW: Render current stage
    function renderCurrentStage() {
        if (!config.stages || config.stages.length === 0) {
            document.getElementById('steps-list').innerHTML = '<p style="color:#586069;">No stages found.</p>';
            document.getElementById('stage-nav').style.display = 'none';
            document.getElementById('stage-nav-bottom').style.display = 'none';
            return;
        }
        
        const stage = config.stages[currentStageIndex];
        renderSteps(stage.steps);
        
        // Update navigation buttons
        document.getElementById('stage-nav').style.display = 'flex';
        document.getElementById('stage-nav-bottom').style.display = 'flex';
        
        const prevBtn = document.getElementById('prev-stage-btn');
        const nextBtn = document.getElementById('next-stage-btn');
        const prevBtnBottom = document.getElementById('prev-stage-btn-bottom');
        const nextBtnBottom = document.getElementById('next-stage-btn-bottom');
        
        prevBtn.disabled = currentStageIndex === 0;
        nextBtn.disabled = currentStageIndex === config.stages.length - 1;
        prevBtnBottom.disabled = currentStageIndex === 0;
        nextBtnBottom.disabled = currentStageIndex === config.stages.length - 1;
    }
    
    // NEW: Stage navigation
    function prevStage() {
        if (currentStageIndex > 0) {
            currentStageIndex--;
            renderStageTabs();
            renderCurrentStage();
            updateProgress();
            window.scrollTo(0, 0);
        }
    }
    
    function nextStage() {
        if (currentStageIndex < config.stages.length - 1) {
            currentStageIndex++;
            renderStageTabs();
            renderCurrentStage();
            updateProgress();
            window.scrollTo(0, 0);
        }
    }
    
    // NEW: Update progress indicator
    function updateProgress() {
        if (!config.stages || config.stages.length === 0) {
            document.getElementById('progress-container').style.display = 'none';
            return;
        }
        
        document.getElementById('progress-container').style.display = 'block';
        
        // Calculate total progress across all stages
        let totalSteps = 0;
        let completedSteps = 0;
        
        config.stages.forEach(stage => {
            totalSteps += stage.steps.length;
            completedSteps += stage.steps.filter(s => s.done).length;
        });
        
        const percentage = totalSteps > 0 ? (completedSteps / totalSteps * 100).toFixed(0) : 0;
        
        document.getElementById('progress-fill').style.width = `${percentage}%`;
        document.getElementById('progress-text').textContent = `${completedSteps} of ${totalSteps} steps completed (${percentage}%)`;
    }

    // Copy to clipboard function
    function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('[SMAX Tool] Copied to clipboard');
                // Visual feedback could be added here
            }).catch(err => {
                console.error('[SMAX Tool] Failed to copy:', err);
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }

    // Fallback copy method for older browsers
    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            // Note: execCommand is deprecated but kept as fallback for legacy browser support
            document.execCommand('copy');
            console.log('[SMAX Tool] Copied using fallback method');
        } catch (err) {
            console.error('[SMAX Tool] Fallback copy failed:', err);
            showError('Copy failed. Please copy manually.');
        }
        document.body.removeChild(textarea);
    }

    // Replace placeholders in commands with actual values
    // Replace placeholders in commands with actual values
    // Supports both {{variable}} and <variable> formats
    function interpolate(str) {
        if (!str) return '';
        let result = str;
        Object.keys(config.config || {}).forEach(key => {
            const val = config.config[key] || '';
            // Replace {{key}} format
            result = result.replace(new RegExp(`{{${key}}}`, 'g'), val);
            // Replace <key> format (case-insensitive)
            result = result.replace(new RegExp(`<${key}>`, 'gi'), val);
            // Also try uppercase version for <KEY> format
            const upperKey = key.toUpperCase();
            result = result.replace(new RegExp(`<${upperKey}>`, 'g'), val);
        });
        return result;
    }

    // Render steps with checkboxes and copy buttons
    function renderSteps(steps) {
        const stepsList = document.getElementById('steps-list');
        stepsList.innerHTML = '';
        
        if (!steps || steps.length === 0) {
            stepsList.innerHTML = '<p style="color:#586069;">No steps in this stage.</p>';
            return;
        }
        
        steps.forEach((step, stepIndex) => {
            const isDone = step.done || false;
            const card = document.createElement('div');
            card.className = `card ${isDone ? 'step-done' : ''}`;
            card.id = `step_${currentStageIndex}_${stepIndex}`;
            
            // Create checkbox label
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '8px';
            label.style.cursor = 'pointer';
            label.style.marginBottom = '12px';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `check_${currentStageIndex}_${stepIndex}`;
            checkbox.checked = isDone;
            checkbox.style.width = '18px';
            checkbox.style.height = '18px';
            checkbox.style.cursor = 'pointer';
            checkbox.onchange = function() {
                toggleStep(currentStageIndex, stepIndex, this.checked);
            };
            
            const title = document.createElement('strong');
            title.style.fontSize = '16px';
            title.textContent = step.title || 'Untitled Step';
            
            label.appendChild(checkbox);
            label.appendChild(title);
            card.appendChild(label);
            
            // Add default notes if present (from step definition)
            if (step.notes && !step.userNotes) {
                const notes = document.createElement('p');
                notes.style.color = '#586069';
                notes.style.margin = '8px 0';
                notes.style.fontStyle = 'italic';
                notes.textContent = step.notes;
                card.appendChild(notes);
            }
            
            // Add command with copy button if present
            if (step.command) {
                const interpolatedCommand = interpolate(step.command);
                const pre = document.createElement('pre');
                pre.style.marginTop = '12px';
                pre.style.position = 'relative';
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = function() {
                    copyToClipboard(interpolatedCommand);
                };
                
                const commandText = document.createTextNode(interpolatedCommand);
                
                pre.appendChild(copyBtn);
                pre.appendChild(commandText);
                card.appendChild(pre);
            }
            
            // NEW: Markdown notes section
            const noteSection = document.createElement('div');
            noteSection.className = 'note-section';
            
            const noteHeader = document.createElement('div');
            noteHeader.className = 'note-header';
            
            const noteTitle = document.createElement('h5');
            noteTitle.textContent = 'üìù Personal Notes';
            
            const noteToggle = document.createElement('button');
            noteToggle.className = 'note-toggle';
            noteToggle.textContent = step.userNotes ? 'Edit' : 'Add Note';
            noteToggle.onclick = () => toggleNoteEditor(currentStageIndex, stepIndex);
            
            noteHeader.appendChild(noteTitle);
            noteHeader.appendChild(noteToggle);
            noteSection.appendChild(noteHeader);
            
            // Note preview
            const notePreview = document.createElement('div');
            notePreview.className = 'note-preview';
            notePreview.id = `note-preview_${currentStageIndex}_${stepIndex}`;
            if (step.userNotes) {
                notePreview.innerHTML = marked.parse(step.userNotes);
            } else {
                notePreview.innerHTML = '<span style="color: #586069; font-style: italic;">No notes added yet</span>';
            }
            noteSection.appendChild(notePreview);
            
            // Note editor
            const noteEditor = document.createElement('div');
            noteEditor.className = 'note-editor';
            noteEditor.id = `note-editor_${currentStageIndex}_${stepIndex}`;
            
            const noteTextarea = document.createElement('textarea');
            noteTextarea.id = `note-textarea_${currentStageIndex}_${stepIndex}`;
            noteTextarea.value = step.userNotes || '';
            noteTextarea.placeholder = 'Enter notes in Markdown format...\n\nExamples:\n# Heading\n**Bold** *Italic*\n- List item\n```code block```';
            noteTextarea.rows = 6;
            noteTextarea.oninput = () => {
                // Live preview
                const preview = document.getElementById(`note-preview_${currentStageIndex}_${stepIndex}`);
                if (noteTextarea.value) {
                    preview.innerHTML = marked.parse(noteTextarea.value);
                } else {
                    preview.innerHTML = '<span style="color: #586069; font-style: italic;">No notes added yet</span>';
                }
            };
            
            const noteButtons = document.createElement('div');
            noteButtons.style.display = 'flex';
            noteButtons.style.gap = '10px';
            noteButtons.style.marginTop = '10px';
            
            const saveNoteBtn = document.createElement('button');
            saveNoteBtn.textContent = 'üíæ Save Note';
            saveNoteBtn.style.background = 'var(--primary)';
            saveNoteBtn.style.color = 'white';
            saveNoteBtn.style.border = 'none';
            saveNoteBtn.style.padding = '8px 16px';
            saveNoteBtn.style.borderRadius = '6px';
            saveNoteBtn.style.cursor = 'pointer';
            saveNoteBtn.onclick = () => saveNote(currentStageIndex, stepIndex);
            
            const cancelNoteBtn = document.createElement('button');
            cancelNoteBtn.textContent = 'Cancel';
            cancelNoteBtn.style.padding = '8px 16px';
            cancelNoteBtn.style.border = '1px solid var(--border)';
            cancelNoteBtn.style.borderRadius = '6px';
            cancelNoteBtn.style.cursor = 'pointer';
            cancelNoteBtn.style.background = 'white';
            cancelNoteBtn.onclick = () => toggleNoteEditor(currentStageIndex, stepIndex);
            
            noteButtons.appendChild(saveNoteBtn);
            noteButtons.appendChild(cancelNoteBtn);
            
            noteEditor.appendChild(noteTextarea);
            noteEditor.appendChild(noteButtons);
            noteSection.appendChild(noteEditor);
            
            card.appendChild(noteSection);
            stepsList.appendChild(card);
        });
    }
    
    // NEW: Toggle note editor
    function toggleNoteEditor(stageIndex, stepIndex) {
        const editor = document.getElementById(`note-editor_${stageIndex}_${stepIndex}`);
        editor.classList.toggle('active');
    }
    
    // NEW: Save note
    function saveNote(stageIndex, stepIndex) {
        const textarea = document.getElementById(`note-textarea_${stageIndex}_${stepIndex}`);
        config.stages[stageIndex].steps[stepIndex].userNotes = textarea.value;
        
        // Update preview
        const preview = document.getElementById(`note-preview_${stageIndex}_${stepIndex}`);
        if (textarea.value) {
            preview.innerHTML = marked.parse(textarea.value);
        } else {
            preview.innerHTML = '<span style="color: #586069; font-style: italic;">No notes added yet</span>';
        }
        
        // Close editor
        toggleNoteEditor(stageIndex, stepIndex);
        
        // Update toggle button text
        const toggle = document.getElementById(`note-editor_${stageIndex}_${stepIndex}`).previousElementSibling.querySelector('.note-toggle');
        toggle.textContent = textarea.value ? 'Edit' : 'Add Note';
        
        console.log('[SMAX Tool] Note saved for step', stepIndex);
    }

    // Toggle step completion status
    function toggleStep(stageIndex, stepIndex, checked) {
        config.stages[stageIndex].steps[stepIndex].done = checked;
        const card = document.getElementById(`step_${stageIndex}_${stepIndex}`);
        if (card) {
            if (checked) {
                card.classList.add('step-done');
            } else {
                card.classList.remove('step-done');
            }
        }
        console.log(`[SMAX Tool] Step ${stepIndex} in stage ${stageIndex} marked as ${checked ? 'done' : 'pending'}`);
        
        // Update progress and stage tabs
        updateProgress();
        renderStageTabs();
    }
    
    // NEW: Reset modal functions
    function showResetModal() {
        document.getElementById('resetModal').style.display = 'block';
    }
    
    function closeResetModal() {
        document.getElementById('resetModal').style.display = 'none';
    }
    
    function confirmReset() {
        if (!config.stages) return;
        
        // Reset all steps
        config.stages.forEach(stage => {
            stage.steps.forEach(step => {
                step.done = false;
            });
        });
        
        // Re-render
        renderStageTabs();
        renderCurrentStage();
        updateProgress();
        closeResetModal();
        
        console.log('[SMAX Tool] All steps reset');
        showSuccess('All steps have been reset');
    }

    // Show success message (non-blocking)
    function showSuccess(msg) {
        const box = document.getElementById('errorBox');
        box.innerText = `‚úÖ ${msg}`;
        box.style.display = 'block';
        box.style.background = '#d4edda';
        box.style.color = '#155724';
        box.style.borderColor = '#c3e6cb';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            box.style.display = 'none';
            box.style.background = '#ffeef0';
            box.style.color = '#d73a49';
            box.style.borderColor = '#f97583';
        }, 3000);
    }

    // Save data function to push unified YAML back to GitHub
    async function saveData() {
        if (!GITHUB_TOKEN) {
            showError('GitHub token required. Please enter token and connect.');
            return;
        }
        
        if (!CURRENT_YAML_PATH) {
            showError('No YAML file path selected. Please load data first.');
            return;
        }
        
        try {
            // Convert config object to YAML
            const yamlContent = jsyaml.dump(config);
            const encodedContent = btoa(yamlContent);
            
            // Update file on GitHub
            const updatePayload = {
                message: `Update ${document.getElementById('selClient').value} configuration`,
                content: encodedContent
            };
            
            // Only include SHA if file exists (for updates)
            if (FILE_SHA) {
                updatePayload.sha = FILE_SHA;
            }
            
            console.log('[SMAX Tool] Saving unified YAML to GitHub:', CURRENT_YAML_PATH);
            
            const response = await fetch(
                `https://api.github.com/repos/${OWNER}/${REPO}/contents/${CURRENT_YAML_PATH}`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatePayload)
                }
            );
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
            }
            
            const result = await response.json();
            FILE_SHA = result.content.sha; // Update SHA for next save
            
            document.getElementById('syncInd').classList.add('online');
            document.getElementById('syncStat').innerText = `Synced: ${document.getElementById('selVer').value}/${document.getElementById('selClient').value}`;
            
            console.log('[SMAX Tool] Data saved successfully');
            showSuccess('Progress saved to GitHub!');
            
        } catch (error) {
            console.error('[SMAX Tool] Save failed:', error);
            showError(`Failed to save: ${error.message}`);
        }
    }
</script>
</body>
</html>
