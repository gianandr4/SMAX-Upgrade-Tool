<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SMAX Upgrade Command Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .nav-bar { background: #24292e; color: white; padding: 15px 20px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-bar select, .nav-bar input { background: #3f4448; color: white; border: 1px solid #4b5155; padding: 8px; border-radius: 4px; }
        .container { flex: 1; overflow-y: auto; padding: 20px; max-width: 1100px; margin: auto; width: 100%; box-sizing: border-box; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .step-done { border-left: 8px solid #28a745; background: #f8fff9; }
        .guide-note { font-size: 0.9em; background: #e7f5ff; border-left: 4px solid #0366d6; padding: 10px; margin: 10px 0; border-radius: 4px; }
        pre { background: #1b1f23; color: #e1e4e8; padding: 15px; border-radius: 6px; position: relative; overflow-x: auto; font-family: "SFMono-Regular", Consolas, monospace; }
        .btn-copy { position: absolute; right: 10px; top: 10px; background: #0366d6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        textarea { width: 100%; border: 1px solid #d1d5da; border-radius: 4px; padding: 10px; margin-top: 10px; box-sizing: border-box; resize: vertical; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #6a737d; }
        .status-online { background: #28a745; }
    </style>
</head>
<body>

<div class="nav-bar">
    <strong>SMAX Ops Hub</strong>
    <input type="password" id="ghToken" placeholder="GitHub PAT" onchange="initSync()">
    
    <select id="pathVer" onchange="loadData()">
        <option value="24.1">v24.1</option>
        <option value="24.2">v24.2</option>
    </select>

    <select id="pathType" onchange="loadData()">
        <option value="managed-steps.yaml">Managed (Classic)</option>
        <option value="embedded-steps.yaml">Embedded (SMAX-E)</option>
    </select>

    <select id="pathClient" onchange="loadData()">
        <option value="client-A">Client A</option>
        <option value="client-B">Client B</option>
        <option value="client-C">Client C</option>
    </select>
    
    <span id="statusIcon" class="status-dot"></span>
    <small id="statusText">Offline</small>
</div>

<div class="container">
    <div class="card" id="vars-card">
        <h3>Environment Variables</h3>
        <div id="var-inputs" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;"></div>
    </div>
    <div id="steps-list"></div>
</div>

<script>
    let config = {};
    let GITHUB_TOKEN = "";
    let FILE_SHA = "";
    let CURRENT_STATE_PATH = "";
    const REPO = window.location.pathname.split('/')[1]; 
    const OWNER = window.location.hostname.split('.')[0];

    async function initSync() {
        GITHUB_TOKEN = document.getElementById('ghToken').value;
        loadData();
    }

    async function loadData() {
        const ver = document.getElementById('pathVer').value;
        const type = document.getElementById('pathType').value;
        const client = document.getElementById('pathClient').value;
        
        const yamlPath = `${ver}/${type}`;
        CURRENT_STATE_PATH = `${ver}/state-${client}.json`;

        try {
            // Load YAML
            const yResp = await fetch(yamlPath);
            config = jsyaml.load(await yResp.text());
            
            // Load Progress from GitHub API
            if (GITHUB_TOKEN) {
                const sResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${CURRENT_STATE_PATH}`, {
                    headers: { Authorization: `token ${GITHUB_TOKEN}` }
                });
                if (sResp.ok) {
                    const data = await sResp.json();
                    FILE_SHA = data.sha;
                    const state = JSON.parse(atob(data.content));
                    
                    // Clear and apply specific client state
                    Object.keys(localStorage).forEach(k => k.startsWith('s_') && localStorage.removeItem(k));
                    Object.entries(state).forEach(([k, v]) => localStorage.setItem(k, v));
                    
                    document.getElementById('statusIcon').className = "status-dot status-online";
                    document.getElementById('statusText').innerText = "Synced";
                }
            }
            renderVars(); renderSteps();
        } catch (e) { alert("Error loading files. Ensure folder structure exists."); }
    }

    async function pushState() {
        if (!GITHUB_TOKEN) return;
        const state = {};
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('s_')) state[k] = localStorage.getItem(k);
        }
        
        const resp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${CURRENT_STATE_PATH}`, {
            method: 'PUT',
            headers: { Authorization: `token ${GITHUB_TOKEN}` },
            body: JSON.stringify({
                message: `Update ${CURRENT_STATE_PATH}`,
                content: btoa(JSON.stringify(state)),
                sha: FILE_SHA
            })
        });
        const result = await resp.json();
        FILE_SHA = result.content.sha;
    }

    function renderVars() {
        const container = document.getElementById('var-inputs');
        container.innerHTML = "";
        for (const [k, v] of Object.entries(config.config)) {
            container.innerHTML += `<div><label style="font-size:12px; font-weight:bold;">${k.toUpperCase()}</label>
                <input type="text" id="v_${k}" value="${v}" oninput="renderSteps()"></div>`;
        }
    }

    function renderSteps() {
        const vars = {};
        Object.keys(config.config).forEach(k => vars[k] = document.getElementById(`v_${k}`).value);
        let html = '';
        config.steps.forEach((step, idx) => {
            const isDone = localStorage.getItem(`s_done_${step.id}`);
            const note = localStorage.getItem(`s_note_${step.id}`) || '';
            let cmd = step.command;
            for (const [k, v] of Object.entries(vars)) cmd = cmd.replaceAll(`{{${k}}}`, v);

            html += `
            <div class="card ${isDone ? 'step-done' : ''}">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" ${isDone ? 'checked' : ''} onclick="toggle('${step.id}')">
                    <h3 style="margin:0; font-size:1.1em; color:#24292e;">${step.title}</h3>
                </div>
                ${step.notes ? `<div class="guide-note">${step.notes}</div>` : ''}
                <pre id="c-${idx}">${cmd}<button class="btn-copy" onclick="copy('c-${idx}')">Copy</button></pre>
                <textarea placeholder="Observation notes (Auto-saved)..." oninput="saveNote('${step.id}', this.value)">${note}</textarea>
            </div>`;
        });
        document.getElementById('steps-list').innerHTML = html;
    }

    function toggle(id) {
        const key = `s_done_${id}`;
        localStorage.getItem(key) ? localStorage.removeItem(key) : localStorage.setItem(key, 'true');
        renderSteps(); pushState();
    }

    function saveNote(id, val) {
        localStorage.setItem(`s_note_${id}`, val);
        pushState();
    }

    function copy(id) {
        const text = document.getElementById(id).innerText.replace('Copy', '');
        navigator.clipboard.writeText(text);
    }

    window.onload = loadData;
</script>
</body>
</html>
