<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAX Multi-Client Upgrade Hub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        :root { --primary: #2ea44f; --dark: #24292e; --bg: #f6f8fa; --border: #d1d5da; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #24292e; }
        
        /* Header & Controls */
        .header { background: var(--dark); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .controls { display: flex; gap: 12px; flex-wrap: wrap; background: #fff; padding: 15px 2rem; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; align-items: center; }
        
        /* Layout */
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 16px; position: relative; }
        .step-done { background: #f0fff4; border-left: 6px solid var(--primary); }
        
        /* Elements */
        pre { background: #1b1f23; color: #e1e4e8; padding: 16px; border-radius: 6px; overflow-x: auto; font-family: ui-monospace, monospace; font-size: 13px; position: relative; }
        .copy-btn { position: absolute; top: 8px; right: 8px; background: #0366d6; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        textarea { width: 100%; margin-top: 10px; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-family: inherit; box-sizing: border-box; }
        input, select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
        
        /* Status Indicators */
        .status-area { display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; background: #d1d5da; }
        .online { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
        .error-msg { background: #ffeef0; color: #d73a49; padding: 10px; border-radius: 6px; margin-bottom: 15px; display: none; border: 1px solid #f97583; }
    </style>
</head>
<body>

<div class="header">
    <strong>SMAX Multi-Tenant Operations</strong>
    <div class="status-area">
        <div id="syncInd" class="indicator"></div>
        <span id="syncStat">Offline</span>
    </div>
</div>

<div class="controls">
    <input type="password" id="ghToken" placeholder="Paste GitHub Token" onchange="connect()">
    
    <select id="selVer" onchange="loadData()">
        <option value="24.1">Version 24.1</option>
        <option value="24.2">Version 24.2</option>
    </select>

    <select id="selType" onchange="loadData()">
        <option value="managed-steps.yaml">Managed SMAX</option>
        <option value="embedded-steps.yaml">Embedded SMAX</option>
    </select>

    <select id="selClient" onchange="loadData()">
        <option value="client-A">Client A</option>
        <option value="client-B">Client B</option>
        <option value="client-C">Client C</option>
    </select>
</div>

<div class="container">
    <div id="errorBox" class="error-msg"></div>

    <div class="card" id="env-vars-card">
        <h4 style="margin-top:0">Environment Variables</h4>
        <div id="var-inputs" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;"></div>
    </div>

    <div id="steps-list"></div>
</div>

<script>
let GITHUB_TOKEN = "";
    let FILE_SHA = "";
    let CURRENT_STATE_PATH = "";
    let config = { config: {}, steps: [] };

    const pathParts = window.location.pathname.split('/').filter(p => p && p !== 'index.html');
    const OWNER = window.location.hostname.split('.')[0];
    const REPO = pathParts[0] || ""; 

    async function connect() {
        GITHUB_TOKEN = document.getElementById('ghToken').value;
        // Step 1: Dynamically find folders
        await fetchFolders();
        // Step 2: Load data for the first folder found
        loadData();
    }

    // NEW: Automatically find version folders (e.g., 24.4, 25.1)
    async function fetchFolders() {
        if (!GITHUB_TOKEN) return;
        try {
            const resp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/`, {
                headers: { Authorization: `token ${GITHUB_TOKEN}` }
            });
            const items = await resp.json();
            const folderSelect = document.getElementById('selVer');
            
            // Clear existing options
            folderSelect.innerHTML = "";

            // Filter for directories that look like versions (numbers/dots)
            const folders = items.filter(item => item.type === 'dir' && !item.name.startsWith('.'));
            
            folders.forEach(folder => {
                const opt = document.createElement('option');
                opt.value = folder.name;
                opt.innerText = `Version ${folder.name}`;
                folderSelect.appendChild(opt);
            });
        } catch (e) {
            showError("Failed to auto-detect folders. check your Token permissions.");
        }
    }

    async function loadData() {
        showError(""); 
        const ver = document.getElementById('selVer').value;
        const type = document.getElementById('selType').value;
        const client = document.getElementById('selClient').value;
        
        if (!ver) return; // Wait until folders are loaded

        const yamlStepsPath = `${ver}/${type}`;
        CURRENT_STATE_PATH = `${ver}/state-${client}.yaml`;

        try {
            const yResp = await fetch(yamlStepsPath);
            if (!yResp.ok) throw new Error(`File not found: ${yamlStepsPath}`);
            config = jsyaml.load(await yResp.text());

            if (GITHUB_TOKEN) {
                const sResp = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${CURRENT_STATE_PATH}`, {
                    headers: { Authorization: `token ${GITHUB_TOKEN}` }
                });
                
                if (sResp.ok) {
                    const data = await sResp.json();
                    FILE_SHA = data.sha;
                    const state = jsyaml.load(atob(data.content)) || {};
                    
                    Object.keys(localStorage).forEach(k => k.startsWith('s_') && localStorage.removeItem(k));
                    Object.entries(state).forEach(([k, v]) => localStorage.setItem(k, v));
                    
                    document.getElementById('syncInd').classList.add('online');
                    document.getElementById('syncStat').innerText = `Synced: ${ver}/${client}`;
                } else {
                    throw new Error(`State file missing: ${CURRENT_STATE_PATH}`);
                }
            }
            renderVars();
            renderSteps();
        } catch (e) {
            showError(e.message);
        }
    }
</script>
</body>
</html>
